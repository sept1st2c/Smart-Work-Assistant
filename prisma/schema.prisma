// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  password      String
  createdAt     DateTime @default(now())

  preferences   UserPreference?
  goals         Goal[]
  tasks         Task[]
  taskHistory   TaskHistory[]
  feedback      Feedback[]
  dailyPlans    DailyPlan[]
  suggestions   SystemSuggestion[]
  weeklySummary WeeklySummary[]

  @@map("users")
}

model UserPreference {
  id                String   @id @default(uuid())
  userId            String   @unique
  maxTasksPerDay    Int      @default(5)
  planningStyle     PlanningStyle @default(BALANCED)
  autoSuggest       Boolean  @default(true)
  autoReschedule    Boolean  @default(true)
  createdAt         DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id])

  @@map("user_preferences")
}

model Goal {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String?
  status      GoalStatus @default(ACTIVE)
  createdAt   DateTime @default(now())

  user        User   @relation(fields: [userId], references: [id])
  tasks       Task[]

  @@map("goals")
}

model Task {
  id              String   @id @default(uuid())
  userId          String
  goalId          String?
  title           String
  description     String?
  estimatedEffort EffortLevel
  importance      Int
  category        String
  deadline        DateTime?
  scheduledDate   DateTime?
  status          TaskStatus @default(PENDING)
  createdAt       DateTime @default(now())

  user            User   @relation(fields: [userId], references: [id])
  goal            Goal?  @relation(fields: [goalId], references: [id])

  history         TaskHistory[]
  feedback        Feedback[]
  planLinks       DailyPlanTask[]
  suggestions     SystemSuggestion[]

  @@map("tasks")
}

model TaskHistory {
  id           String   @id @default(uuid())
  taskId       String
  userId       String
  action       TaskAction
  previousDate DateTime?
  newDate      DateTime?
  createdAt    DateTime @default(now())

  task         Task @relation(fields: [taskId], references: [id])
  user         User @relation(fields: [userId], references: [id])

  @@map("task_history")
}

model Feedback {
  id          String   @id @default(uuid())
  taskId      String
  userId      String
  type        FeedbackType
  note        String?
  createdAt   DateTime @default(now())

  task        Task @relation(fields: [taskId], references: [id])
  user        User @relation(fields: [userId], references: [id])

  @@map("feedback")
}

model DailyPlan {
  id              String   @id @default(uuid())
  userId          String
  date            DateTime
  maxTasksAllowed Int
  createdAt       DateTime @default(now())

  user            User @relation(fields: [userId], references: [id])
  tasks           DailyPlanTask[]

  @@unique([userId, date])
  @@map("daily_plans")
}

model DailyPlanTask {
  id         String   @id @default(uuid())
  planId    String
  taskId    String
  order     Int
  locked    Boolean  @default(false)

  plan      DailyPlan @relation(fields: [planId], references: [id])
  task      Task      @relation(fields: [taskId], references: [id])

  @@unique([planId, taskId])
  @@map("daily_plan_tasks")
}

model SystemSuggestion {
  id             String   @id @default(uuid())
  userId         String
  taskId         String?
  type           SuggestionType
  suggestedDate  DateTime?
  explanation    String
  accepted       Boolean?
  createdAt      DateTime @default(now())

  user           User  @relation(fields: [userId], references: [id])
  task           Task? @relation(fields: [taskId], references: [id])

  @@map("system_suggestions")
}

model WeeklySummary {
  id              String   @id @default(uuid())
  userId          String
  weekStart       DateTime
  completionRate  Float
  overdueCount    Int
  insight         String
  createdAt       DateTime @default(now())

  user            User @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart])
  @@map("weekly_summaries")
}

/* =======================
   ENUMS
======================= */

enum PlanningStyle {
  CHILL
  BALANCED
  HUSTLE
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  PENDING
  DONE
  SKIPPED
  POSTPONED
}

enum EffortLevel {
  EASY
  MEDIUM
  HARD
}

enum TaskAction {
  CREATED
  RESCHEDULED
  COMPLETED
  SKIPPED
  POSTPONED
}

enum FeedbackType {
  TOO_BIG
  NO_TIME
  LOST_MOTIVATION
  OTHER
}

enum SuggestionType {
  SCHEDULE
  RESCHEDULE
  DEPRIORITIZE
  OVERLOAD_WARNING
}
